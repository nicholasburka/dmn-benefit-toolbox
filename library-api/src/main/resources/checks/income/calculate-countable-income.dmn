<?xml version="1.0" encoding="UTF-8"?>
<dmn:definitions xmlns:dmn="http://www.omg.org/spec/DMN/20180521/MODEL/"
                 xmlns="https://kie.apache.org/dmn/_5C6D7E8F-9A0B-1C2D-3E4F-5A6B7C8D9E0F"
                 xmlns:feel="http://www.omg.org/spec/DMN/20180521/FEEL/"
                 xmlns:kie="http://www.drools.org/kie/dmn/1.2"
                 xmlns:dmndi="http://www.omg.org/spec/DMN/20180521/DMNDI/"
                 id="_6D7E8F9A-0B1C-2D3E-4F5A-6B7C8D9E0F1A"
                 name="CalculateCountableIncome"
                 typeLanguage="http://www.omg.org/spec/DMN/20180521/FEEL/"
                 namespace="https://kie.apache.org/dmn/_5C6D7E8F-9A0B-1C2D-3E4F-5A6B7C8D9E0F">

  <dmn:description>POMS SI 00810.000 - SI 00830.000: Calculate countable income by applying earned/unearned exclusions in correct order.

Calculation order:
1. Apply $20 general exclusion to unearned income first
2. Spillover unused general exclusion to earned income
3. Apply $65 earned income exclusion
4. Exclude 50% of remaining earned income
5. Sum countable unearned + countable earned
6. Compare to Federal Benefit Rate (FBR)</dmn:description>

  <!-- Import BDT base module -->
  <dmn:import id="_7E8F9A0B-1C2D-3E4F-5A6B-7C8D9E0F1A2B"
              name="BDT"
              namespace="https://kie.apache.org/dmn/_1B91A885-130A-4E0B-A762-E12AA6DD5C79"
              locationURI="../../BDT.dmn"
              importType="http://www.omg.org/spec/DMN/20180521/MODEL/"/>

  <!-- Parameters type definition -->
  <dmn:itemDefinition id="_8F9A0B1C-2D3E-4F5A-6B7C-8D9E0F1A2B3C" name="tParameters" isCollection="false">
    <dmn:itemComponent id="_9A0B1C2D-3E4F-5A6B-7C8D-9E0F1A2B3C4D" name="personId" isCollection="false">
      <dmn:typeRef>string</dmn:typeRef>
    </dmn:itemComponent>
    <dmn:itemComponent id="_A0B1C2D3-4E5F-6A7B-8C9D-0E1F2A3B4C5D" name="FBR" isCollection="false">
      <dmn:typeRef>number</dmn:typeRef>
    </dmn:itemComponent>
  </dmn:itemDefinition>

  <!-- Input: situation -->
  <dmn:inputData id="_B1C2D3E4-5F6A-7B8C-9D0E-1F2A3B4C5D6E" name="situation">
    <dmn:extensionElements/>
    <dmn:variable id="_C2D3E4F5-6A7B-8C9D-0E1F-2A3B4C5D6E7F"
                  name="situation"
                  typeRef="BDT.tSituation"/>
  </dmn:inputData>

  <!-- Input: parameters -->
  <dmn:inputData id="_D3E4F5A6-7B8C-9D0E-1F2A-3B4C5D6E7F8A" name="parameters">
    <dmn:extensionElements/>
    <dmn:variable id="_E4F5A6B7-8C9D-0E1F-2A3B-4C5D6E7F8A9B"
                  name="parameters"
                  typeRef="tParameters"/>
  </dmn:inputData>

  <!-- Decision: incomeCalculation -->
  <dmn:decision id="_F5A6B7C8-9D0E-1F2A-3B4C-5D6E7F8A9B0C" name="incomeCalculation">
    <dmn:description>Calculate countable income by applying POMS exclusions in correct order</dmn:description>
    <dmn:extensionElements/>
    <dmn:variable id="_A6B7C8D9-0E1F-2A3B-4C5D-6E7F8A9B0C1D"
                  name="incomeCalculation"
                  typeRef="BDT.tIncomeCalculation"/>
    <dmn:informationRequirement id="_B7C8D9E0-1F2A-3B4C-5D6E-7F8A9B0C1D2E">
      <dmn:requiredInput href="#_B1C2D3E4-5F6A-7B8C-9D0E-1F2A3B4C5D6E"/>
    </dmn:informationRequirement>
    <dmn:informationRequirement id="_C8D9E0F1-2A3B-4C5D-6E7F-8A9B0C1D2E3F">
      <dmn:requiredInput href="#_D3E4F5A6-7B8C-9D0E-1F2A-3B4C5D6E7F8A"/>
    </dmn:informationRequirement>

    <dmn:context id="_D9E0F1A2-3B4C-5D6E-7F8A-9B0C1D2E3F4A">
      <!-- Step 1: Extract person and their income sources -->
      <dmn:contextEntry>
        <dmn:variable id="_E0F1A2B3-4C5D-6E7F-8A9B-0C1D2E3F4A5B" name="person" typeRef="BDT.tPerson"/>
        <dmn:literalExpression id="_F1A2B3C4-5D6E-7F8A-9B0C-1D2E3F4A5B6C">
          <dmn:text>situation.people[id = parameters.personId][1]</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <dmn:contextEntry>
        <dmn:variable id="_A2B3C4D5-6E7F-8A9B-0C1D-2E3F4A5B6C7D" name="incomeSources" typeRef="BDT.tIncomeSourceList"/>
        <dmn:literalExpression id="_B3C4D5E6-7F8A-9B0C-1D2E-3F4A5B6C7D8E">
          <dmn:text>person.incomeSources</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 2: Calculate total earned and unearned income -->
      <dmn:contextEntry>
        <dmn:variable id="_C4D5E6F7-8A9B-0C1D-2E3F-4A5B6C7D8E9F" name="totalEarnedIncome" typeRef="number"/>
        <dmn:literalExpression id="_D5E6F7A8-9B0C-1D2E-3F4A-5B6C7D8E9F0A">
          <dmn:text>if incomeSources = null then
  0
else
  sum(for i in incomeSources return if i.type = "earned" then i.monthlyAmount else 0)</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <dmn:contextEntry>
        <dmn:variable id="_E6F7A8B9-0C1D-2E3F-4A5B-6C7D8E9F0A1B" name="totalUnearnedIncome" typeRef="number"/>
        <dmn:literalExpression id="_F7A8B9C0-1D2E-3F4A-5B6C-7D8E9F0A1B2C">
          <dmn:text>if incomeSources = null then
  0
else
  sum(for i in incomeSources return if i.type = "unearned" then i.monthlyAmount else 0)</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 3: Apply $20 general exclusion to unearned income first -->
      <dmn:contextEntry>
        <dmn:variable id="_A8B9C0D1-2E3F-4A5B-6C7D-8E9F0A1B2C3D" name="generalExclusionToUnearned" typeRef="number"/>
        <dmn:literalExpression id="_B9C0D1E2-3F4A-5B6C-7D8E-9F0A1B2C3D4E">
          <dmn:text>if totalUnearnedIncome >= 20 then 20 else totalUnearnedIncome</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <dmn:contextEntry>
        <dmn:variable id="_C0D1E2F3-4A5B-6C7D-8E9F-0A1B2C3D4E5F" name="unusedGeneralExclusion" typeRef="number"/>
        <dmn:literalExpression id="_D1E2F3A4-5B6C-7D8E-9F0A-1B2C3D4E5F6A">
          <dmn:text>if totalUnearnedIncome &lt; 20 then 20 - totalUnearnedIncome else 0</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 4: Calculate countable unearned income -->
      <dmn:contextEntry>
        <dmn:variable id="_E2F3A4B5-6C7D-8E9F-0A1B-2C3D4E5F6A7B" name="countableUnearnedIncome" typeRef="number"/>
        <dmn:literalExpression id="_F3A4B5C6-7D8E-9F0A-1B2C-3D4E5F6A7B8C">
          <dmn:text>if totalUnearnedIncome > 20 then totalUnearnedIncome - 20 else 0</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 5: Apply exclusions to earned income -->
      <dmn:contextEntry>
        <dmn:variable id="_A4B5C6D7-8E9F-0A1B-2C3D-4E5F6A7B8C9D" name="earnedAfterGeneralExclusion" typeRef="number"/>
        <dmn:literalExpression id="_B5C6D7E8-9F0A-1B2C-3D4E-5F6A7B8C9D0E">
          <dmn:text>if totalEarnedIncome > unusedGeneralExclusion then totalEarnedIncome - unusedGeneralExclusion else 0</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <dmn:contextEntry>
        <dmn:variable id="_C6D7E8F9-0A1B-2C3D-4E5F-6A7B8C9D0E1F" name="earnedAfter65Exclusion" typeRef="number"/>
        <dmn:literalExpression id="_D7E8F9A0-1B2C-3D4E-5F6A-7B8C9D0E1F2A">
          <dmn:text>if earnedAfterGeneralExclusion > 65 then earnedAfterGeneralExclusion - 65 else 0</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <dmn:contextEntry>
        <dmn:variable id="_E8F9A0B1-2C3D-4E5F-6A7B-8C9D0E1F2A3B" name="countableEarnedIncome" typeRef="number"/>
        <dmn:literalExpression id="_F9A0B1C2-3D4E-5F6A-7B8C-9D0E1F2A3B4C">
          <dmn:text>earnedAfter65Exclusion / 2</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 6: Track total exclusions applied to earned income -->
      <dmn:contextEntry>
        <dmn:variable id="_A0B1C2D3-4E5F-6A7B-8C9D-0E1F2A3B4C5X" name="earnedExclusionApplied" typeRef="number"/>
        <dmn:literalExpression id="_B1C2D3E4-5F6A-7B8C-9D0E-1F2A3B4C5D6E">
          <dmn:text>totalEarnedIncome - countableEarnedIncome</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 7: Calculate total countable income -->
      <dmn:contextEntry>
        <dmn:variable id="_C2D3E4F5-6A7B-8C9D-0E1F-2A3B4C5D6E7F" name="totalCountableIncome" typeRef="number"/>
        <dmn:literalExpression id="_D3E4F5A6-7B8C-9D0E-1F2A-3B4C5D6E7F8A">
          <dmn:text>countableUnearnedIncome + countableEarnedIncome</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 8: Determine applicable FBR -->
      <dmn:contextEntry>
        <dmn:variable id="_E4F5A6B7-8C9D-0E1F-2A3B-4C5D6E7F8A9B" name="applicableFBR" typeRef="number"/>
        <dmn:literalExpression id="_F5A6B7C8-9D0E-1F2A-3B4C-5D6E7F8A9B0C">
          <dmn:text>if parameters.FBR != null then parameters.FBR else 967</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 9: Check if meets income limit -->
      <dmn:contextEntry>
        <dmn:variable id="_A6B7C8D9-0E1F-2A3B-4C5D-6E7F8A9B0C1D" name="meetsIncomeLimit" typeRef="boolean"/>
        <dmn:literalExpression id="_B7C8D9E0-1F2A-3B4C-5D6E-7F8A9B0C1D2E">
          <dmn:text>totalCountableIncome &lt; applicableFBR</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>

      <!-- Step 10: Return full calculation result -->
      <dmn:contextEntry>
        <dmn:literalExpression id="_C8D9E0F1-2A3B-4C5D-6E7F-8A9B0C1D2E3F">
          <dmn:text>{
  totalEarnedIncome: totalEarnedIncome,
  totalUnearnedIncome: totalUnearnedIncome,
  generalExclusionApplied: generalExclusionToUnearned + unusedGeneralExclusion,
  earnedIncomeExclusionApplied: earnedExclusionApplied,
  countableUnearnedIncome: countableUnearnedIncome,
  countableEarnedIncome: countableEarnedIncome,
  totalCountableIncome: totalCountableIncome,
  applicableFBR: applicableFBR,
  meetsIncomeLimit: meetsIncomeLimit
}</dmn:text>
        </dmn:literalExpression>
      </dmn:contextEntry>
    </dmn:context>
  </dmn:decision>

  <!-- Decision Service -->
  <dmn:decisionService id="_D9E0F1A2-3B4C-5D6E-7F8A-9B0C1D2E3F4A" name="CalculateCountableIncomeService">
    <dmn:extensionElements/>
    <dmn:variable id="_E0F1A2B3-4C5D-6E7F-8A9B-0C1D2E3F4A5B"
                  name="CalculateCountableIncomeService"
                  typeRef="BDT.tIncomeCalculation"/>
    <dmn:outputDecision href="#_F5A6B7C8-9D0E-1F2A-3B4C-5D6E7F8A9B0C"/>
    <dmn:inputData href="#_B1C2D3E4-5F6A-7B8C-9D0E-1F2A3B4C5D6E"/>
    <dmn:inputData href="#_D3E4F5A6-7B8C-9D0E-1F2A-3B4C5D6E7F8A"/>
  </dmn:decisionService>

</dmn:definitions>
